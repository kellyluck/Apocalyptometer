<!DOCTYPE html>

<script>
    let apocalypses = [];

    window.onload = function () {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0'); // Day
        var mm = String(today.getMonth() + 1).padStart(2, '0'); // Month
        var yyyy = today.getFullYear(); // Year

        var birthDateControl = document.getElementById("birthDate");

        birthDateControl.value = yyyy - 30 + '-' + mm + '-' + dd; // good as any
        birthDateControl.min = yyyy - 200 + '-' + mm + '-' + dd; // yer ass ain't over 200. Shuddup.
        birthDateControl.max = yyyy + '-' + mm + '-' + dd;
    }

    window.addEventListener('DOMContentLoaded', async () => {
        apocalypses = await loadRecords('./apocalyptic_events.json');

        var otd = onThisDay();
        if (otd !== "") {
            document.getElementById("triviaTitle").textContent="This Day in Apocalyptic History";
            document.getElementById("trivia").innerHTML=new Date(otd.date).toLocaleDateString() + "<br />" + otd.claimants + "<br />" + otd.description;
        } else {
            trivia=randomOne();
            document.getElementById("triviaTitle").textContent="Your Random-Apocalypse-of-the-Whenever";
            document.getElementById("trivia").innerHTML=new Date(trivia.date).toLocaleDateString() + "<br />" + trivia.claimants + "<br />" + trivia.description;
        }
    });

    async function loadRecords(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const records = await response.json();
            return records;
        } catch (err) {
            console.error('Error loading JSON file:', err);
            return [];
        }
    }

    function btnCalculate() {
        var birthDateControl = document.getElementById("birthDate");
        var birthDate = new Date(birthDateControl.value);

        const filtered = apocalypses.filter(record => new Date(record.date) >= birthDate
            && new Date(record.date) <= new Date());

        // If nothing matches
        if (filtered.length === 0) {
            document.getElementById("lblApocalypti").textContent = "0";
            document.getElementById("theList").innerHTML = "Somehow you haven't been through a single apocalypse yet. You must be, like, <i>really</i> young.";
        } else {
            document.getElementById("lblApocalypti").textContent = filtered.length;
            let html = '<table border="1" cellpadding="6" cellspacing="0">';
            html += '<tbody>';

            filtered.forEach(record => {
                html += '<tr><td>';
                html += `<b>date</b>: ${new Date(record.date).toLocaleDateString()}<br />`;
                html += `<b>claimants</b>: ${record.claimants}<br />`;
                html += `<b>description</b>: ${record.description}<br />`;
                html += '</td></tr>';
            });
            html += '</tbody></table>';
            document.getElementById("theList").innerHTML = html;
        }

        document.getElementById("divResults").style = "visibility:visible";
    }

    function onThisDay() {
        var otd = "";
        var todayMonth = new Date().getMonth() + 1; // because getMonth() is 0-based for god-knows-what reason
        var todayDay = new Date().getDate(); // not getDate() though. That would be *consistent*.

        const filtered = apocalypses.filter(record => new Date(record.date).getMonth == todayMonth
            && new Date(record.date).getDate == todayDay);

        if (filtered.length === 0) return "";

        index = Math.floor(Math.random() * filtered.length);

        return filtered[index];
    }

    function randomOne() {
        index = Math.floor(Math.random() * apocalypses.length);

        return apocalypses[index];
    }

</script>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>The Incredible Apocalyptometer(tm)</title>
</head>

<body>
    <p style="text-align: center;">The Incredible</p>
    <div style="text-align:center; width:100%">
        <span style="text-align: center; font-size: 5em; vertical-align: top;">Apocalyptometer</span><span
            style="vertical-align: text-top;"><sup>(tm)</sup></span>
    </div>
    <p style="text-align: center;"></p>
    <p style="text-align: center;">"Because it's always the End of the World Somewhere"</p>
    <p style="text-align: center;"></p>
    <p style="text-align: left;">Let's face it, dear friends, the world is teetering on the brink of disaster, and
        pretty much always has been. But fear not! You are a survivor&mdash;yes, you! Don't believe me? Merely enter
        your date of birth below, and discover how many apocalyptic predictions you have survived thus far; it's
        probably more than you think!</p>
    <p />
        <div style="border: 2px solid; border-color: red; width: 50%; margin: auto; text-align: center; padding: 10px;">
            <span id="triviaTitle" style="font-weight: bold;"></span>
            <br /><br />
            <span id="trivia"></span>
        </div>
    <p />
    <p style="text-align: left;">(Totally cribbed from <a
            href="https://en.wikipedia.org/wiki/List_of_dates_predicted_for_apocalyptic_events">Wikipedia</a>)</p>
    <p style="text-align: left;">
        Date of birth:&nbsp;
        <input type="date" id="birthDate" />
        &nbsp;
        <input type="submit" id="btnGo" value="Gimme the bad news" onclick="btnCalculate()" />
    </p>

    <p style="text-align: left;"></p>
    <p style="text-align: left;"></p>

    <div style="visibility: collapse;" id="divResults">
        <div style="text-align:center; width:100%">
            <span style="text-align: center;">Congratulations! You've survived</span>
            <h1 style="text-align: center; font-size: 5em;" id="lblApocalypti"></h1>
            <div style="align-content: center;">
                <span style="text-align: center; font-size: larger;">Apocalypses</span><br />
                <span style="text-align: center; font-size: xx-small">(apocalypti? apocalyptae?)</span></p>
            </div>
        </div>
        <div id="theList"></div>
    </div>
</body>

</html>